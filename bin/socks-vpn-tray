#!/usr/bin/env python3

# /usr/local/bin/socks-vpn-tray - A system tray application to manage the Socks VPN service.

from enum import Enum
import json
import sys
import shutil
from typing import Dict, Optional
from urllib.request import urlopen
import subprocess
from PyQt5 import QtWidgets, QtGui, QtCore
from dataclasses import dataclass

SERVICE = "socks-vpn"

@dataclass
class PublicIdentity:
    ip: str
    city: Optional[str]
    country: Optional[str]

    def __str__(self):
        parts = [self.ip]
        if self.city:
            parts.append(self.city)
        if self.country:
            parts.append(self.country)
        return ", ".join(parts)

    def __eq__(self, other):
        if not isinstance(other, PublicIdentity):
            return False
        return (self.ip == other.ip and
                self.city == other.city and
                self.country == other.country)
    
    def __ne__(self, other):
        return not self.__eq__(other)
    
    def __hash__(self):
        return hash((self.ip, self.city, self.country))

    def __bool__(self):
        return bool(self.ip)

def run_cmd(cmd):
    try:
        p = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        return p.returncode, p.stdout.strip(), p.stderr.strip()
    except Exception as e:
        return 1, "", str(e)

def systemctl(*args):
    return run_cmd(["systemctl"] + list(args))

def is_active():
    rc, out, err = systemctl("is-active", SERVICE)
    return rc == 0 and out == "active"

def get_public_identity() -> Optional[PublicIdentity]:
    try:
        url = 'http://ipinfo.io/json'
        response = urlopen(url)
        data = json.load(response)

        ip=data['ip']
        city = data['city']
        country=data['country']

        return PublicIdentity(ip=ip, city=city, country=country)
    except Exception:
        return None

class ConnectionStatus(Enum):
    INACTIVE = 0
    BUSY = 1
    ACTIVE = 2

TRAY_ICONS: Dict[ConnectionStatus, str] = {
    ConnectionStatus.INACTIVE:  "media-playback-stop",
    ConnectionStatus.BUSY:      "process-working",
    ConnectionStatus.ACTIVE:    "media-playback-start",
}

class TrayApp(QtWidgets.QSystemTrayIcon):
    def __init__(self, icon, parent=None):
        super().__init__(icon, parent)
        self.setToolTip("Socks VPN Tray")

        self.status = None
        self.public_identity: Optional[PublicIdentity] = None
        self._pub_id_updated = False
        self._pub_id_fails = 0

        self._refreshing = False

        self.menu = QtWidgets.QMenu()
        self.action_start = self.menu.addAction("Start")
        self.action_stop  = self.menu.addAction("Stop")
        self.action_restart = self.menu.addAction("Restart")
        self.menu.addSeparator()
        self.action_quit = self.menu.addAction("Quit")
        self.setContextMenu(self.menu)
        self.action_start.triggered.connect(self.start_service)
        self.action_stop.triggered.connect(self.stop_service)
        self.action_restart.triggered.connect(self.restart_service)
        self.action_quit.triggered.connect(QtWidgets.qApp.quit)
        self.activated.connect(self.on_click)

        self.ip_timer = QtCore.QTimer(self)
        self.ip_timer.timeout.connect(self.update_public_identity)

        self.status_timer = QtCore.QTimer(self)
        self.status_timer.timeout.connect(self.refresh_status)
        
        self.update_status(ConnectionStatus.BUSY)
        self.refresh_status()

    def on_click(self, reason):
        # left-click toggles start/stop
        if reason == QtWidgets.QSystemTrayIcon.Trigger:
            if self.status == ConnectionStatus.BUSY:
                return

            if is_active():
                self.stop_service()
            else:
                self.start_service()

    def update_public_identity(self):
        identity = get_public_identity()
        if not identity:
            self._pub_id_fails += 1

        if identity and (identity != self.public_identity or self._pub_id_fails > 0):
            self.public_identity = identity
            self._pub_id_updated = True
            self._pub_id_fails = 0

    def refresh_status(self):
        if self._refreshing:
            return
        self._refreshing = True
        
        active = is_active()
        self.action_start.setEnabled(not active)
        self.action_stop.setEnabled(active)

        if active:
            if self.status == ConnectionStatus.BUSY and self._pub_id_updated:
                self.showMessage("Connected", f"Public IP: {self.public_identity}")
                self.update_status(ConnectionStatus.ACTIVE)
            
            self.setToolTip(f"Socks VPN is running")
        else:
            if self.status != ConnectionStatus.INACTIVE:
                self.showMessage("Disconnected", "Socks VPN is inactive.")
                self.update_status(ConnectionStatus.INACTIVE)
            self.setToolTip(f"Socks VPN is inactive")

        self._refreshing = False

    def update_status(self, status: ConnectionStatus):
        if self.status == status:
            return
        
        self.status = status
        self._pub_id_updated = False
        self.setIcon(QtGui.QIcon.fromTheme(TRAY_ICONS[self.status]))

        # Stop status timer
        if self.status_timer.isActive():
            self.status_timer.stop()

        if self.status == ConnectionStatus.BUSY:
            self.ip_timer.start(1000)  # check every 2 seconds
            self.status_timer.start(500)  # refresh status every 0.5 seconds
            QtCore.QTimer.singleShot(1, self.update_public_identity)
        else:
            self.ip_timer.stop()
            self.status_timer.start(5000)  # refresh status every 5 seconds

    def start_service(self):
        rc, out, err = systemctl("start", SERVICE)
        if rc == 0:
            self.showMessage("Service started", "It may take a few seconds to connect.")
            self.update_status(ConnectionStatus.BUSY)
        else:
            self.showMessage("Failed to start", f"{err or out}", QtWidgets.QSystemTrayIcon.MessageIcon.Critical)
        self.refresh_status()

    def stop_service(self):
        rc, out, err = systemctl("stop", SERVICE)
        if rc == 0:
            self.showMessage("Service stopped", "Socks VPN has been stopped.")
            self.update_status(ConnectionStatus.INACTIVE)
        else:
            self.showMessage("Failed to stop", f"{err or out}", QtWidgets.QSystemTrayIcon.MessageIcon.Critical)
        self.refresh_status()

    def restart_service(self):
        rc, out, err = systemctl("restart", SERVICE)
        if rc == 0:
            self.showMessage("Service restarted", "It may take a few seconds to reconnect.")
            self.update_status(ConnectionStatus.BUSY)
        else:
            self.showMessage("Failed to restart", f"{err or out}", QtWidgets.QSystemTrayIcon.MessageIcon.Critical)
        self.refresh_status()

def main():
    app = QtWidgets.QApplication(["Socks VPN Tray"])
    # ensure tray is available
    if not QtWidgets.QSystemTrayIcon.isSystemTrayAvailable():
        print("System tray not available")
        sys.exit(1)

    # pick a fallback icon if theme icons not present
    icon = QtGui.QIcon.fromTheme("system-run")
    if icon.isNull():
        icon = app.style().standardIcon(QtWidgets.QStyle.SP_ComputerIcon)

    tray = TrayApp(icon)
    tray.show()
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
